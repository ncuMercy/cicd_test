steps:
  # ==============================
  # STAGE 1: CONTINUOUS INTEGRATION (CI)
  # ==============================

  # Step 1: Install Dependencies
- name: 'node:22'
  entrypoint: 'npm'
  id: 'INSTALL_DEPS'
  dir: 'frontend'
  args: ['ci']

  # Step 2: Build Application
- name: 'node:22'
  entrypoint: 'npm'
  id: 'BUILD_APP'
  dir: 'frontend'
  env:
    - VITE_BUCKET_NAME=${_BUCKET_NAME}-stage
  args: ['run', 'build']
  waitFor: ['INSTALL_DEPS']

  # Step 3: Run Automated Tests
- name: 'node:22'
  entrypoint: 'npm'
  id: 'UNIT_TESTS'
  dir: 'frontend'
  args: ['run', 'test:unit']
  waitFor: ['INSTALL_DEPS']

  # ==============================
  # STAGE 2: CONTINUOUS DEPLOYMENT (CD)
  # ==============================

  # Step 4: Create Versioned Artifact
- name: 'gcr.io/cloud-builders/gsutil'
  id: 'DEPLOY_TO_STAGING'
  dir: 'frontend'
  args: ['rsync', '-r', './dist', 'gs://${_BUCKET_NAME}-stage']

  # Step 5: Run Staging Tests
- name: mcr.microsoft.com/playwright:v1.55.0-noble
  entrypoint: bash
  dir: 'frontend'
  id: 'E2E_TESTS'
  env:
    - PLAYWRIGHT_BASE_URL=https://storage.googleapis.com
    - VITE_BUCKET_NAME=${_BUCKET_NAME}-stage
  allowFailure: true
  args:
    - -c
    - |
      npm ci
      npx playwright install chromium
      npx playwright test
  waitFor: ['DEPLOY_TO_STAGING']

# Send email notification on build success or failure
- name: 'curlimages/curl:latest'
  id: 'SEND_GMAIL_NOTIFICATION'
  waitFor: ['E2E_TESTS']
  entrypoint: 'sh'
  args:
    - '-c'
    - |
      BUILD_STATUS="$_STATUS" 
      EMAIL_CONTENT="From: peiyu20240219@gmail.com
      To: peiyu20240219@gmail.com
      Subject: Build $BUILD_STATUS - ${REPO_NAME}
      Content-Type: text/html

      <h2>Build $BUILD_STATUS</h2>
      <p><strong>Project:</strong> ${PROJECT_ID}</p>
      <p><strong>Build ID:</strong> ${BUILD_ID}</p>
      <p><strong>Repository:</strong> ${REPO_NAME}</p>
      <p><a href='https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=${PROJECT_ID}'>View Build Logs</a></p>"

      ENCODED_EMAIL=$(echo "$EMAIL_CONTENT" | base64 -w 0 | tr '/+' '_-' | tr -d '=')

      curl -X POST \
        "https://gmail.googleapis.com/gmail/v1/users/me/messages/send" \
        -H "Authorization: Bearer $$GMAIL_ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"raw\": \"$ENCODED_EMAIL\"}"
        
      echo "Gmail API notification sent with status: $BUILD_STATUS"
  secretEnv: ['GMAIL_ACCESS_TOKEN']

  # Step 8: Deploy to Production
- name: 'gcr.io/cloud-builders/gsutil'
  id: 'DEPLOY_TO_PRODUCTION'
  dir: 'frontend'
  args: ['rsync', '-r', './dist', 'gs://${_BUCKET_NAME}-production']
  waitFor: ['E2E_TESTS']

timeout: '600s'

options:
  logging: CLOUD_LOGGING_ONLY

availableSecrets:
  secretManager:
  - versionName: projects/174997059597/secrets/GMAIL_ACCESS_TOKEN/versions/latest
    env: 'GMAIL_ACCESS_TOKEN'
